<html>
<body style="
    background-image: url(file:///Users/wrongway/Documents/dev/game/im/back.png);
    width: 1590;
    height: 530;
    background-repeat: repeat;
    background-size: cover;
">

<script>
    var xDelta = 0;
    var yDelta = 0;
    var canMoveX = true;
    var canMoveY = true;
    var movesX = true;
    var movesY = true;
    var deltaModule = 2;
    
    document.addEventListener('keydown', function(event) {
        console.log('Key: ', event.key);
        console.log('keyCode: ', event.keyCode);
    
        // Left
        if (event.keyCode == 37) {
            xDelta = -deltaModule;
            // yDelta = 0;
        }

        // Right
        if (event.keyCode == 39) {
            xDelta = deltaModule;
            // yDelta = 0;
        }

        // Up
        if (event.keyCode == 38) {
            yDelta = deltaModule;
            // xDelta = 0;
        }

        // Down
        if (event.keyCode == 40) {
            yDelta = -deltaModule;
            // xDelta = 0;
        }
    });
    
    class Object {

        constructor(type, bottom, left, backgroundSize="contain", position="absolute") {
            this.type = type;
            this.id = this.generateId();
            this.divElement = document.createElement('div');
            this.divElement.setAttribute('id', this.id);
            document.body.appendChild(this.divElement);

            this.y = parseInt(bottom);
            this.x = parseInt(left);
            this.backgroundSize = backgroundSize;
            this.backgroundPosition = position;
            this.width = parseInt("100px");
            this.height = parseInt("100px");

            switch (this.type) {
                case "stone":
                    this.backgroundImage = "url(file:///Users/wrongway/Documents/dev/game/im/floor.png)";    
                    break;
                case "hero":
                    this.backgroundImage = "url(file:///Users/wrongway/Documents/dev/game/im/pers3.png)";
                    this.width = parseInt("50px");
                    this.height = parseInt("100px");
                    break;
                case "flag":
                    this.backgroundImage = "url(file:///Users/wrongway/Documents/dev/game/im/flag.png)";
                    break;
                case "spikes":
                    this.backgroundImage = "url(file:///Users/wrongway/Documents/dev/game/im/spikes.png)";
                    break;
            }

        }
        static counter = 0;

        generateId() {
            if (this.type == "hero") {
                return "hero";
            }
            else {
                let result = Object.counter;
                Object.counter += 1;
                return "obj" + result;
            }
        }

        render() {
            let style = this.divElement.style;
            style.width = this.width + "px";
            style.height = this.height + "px";
            style.backgroundSize = this.backgroundSize;
            style.backgroundImage = this.backgroundImage;
            style.bottom = this.y + "px";
            style.left = this.x + "px";
            style.position = this.backgroundPosition;
        }
    }

    var objects = [];

    for (var i = 0; i < 1600; i += 100) {
        var stone = new Object("stone", "0px", i + "px");
        if (i == 500) {
            continue;
        }
        objects.push(stone);  
    }

    let hero = new Object("hero", "101px", "100px");
    objects.push(hero);

    let flag = new Object("flag", "100px", "1300px");
    objects.push(flag);

    let spikes = new Object("spikes", "0px", "500px");
    objects.push(spikes);

    spikes = new Object("spikes", "100px", "300px");
    objects.push(spikes);

    stone = new Object("stone", "200px", "300px");
    objects.push(stone);

    stone = new Object("stone", "200px", "500px");
    objects.push(stone);

    stone = new Object("stone", "300px", "700px");
    objects.push(stone);

    spikes = new Object("spikes", "100", "800px");
    objects.push(spikes);
    
    spikes = new Object("spikes", "100", "900px");
    objects.push(spikes);

    spikes = new Object("spikes", "100", "1000px");
    objects.push(spikes);

    function render() {
        for (var i = 0; i < objects.length; i++) {
            var obj = objects[i];
            obj.render();
        }
    }

    function moveX() {
        if (canMoveX) {
            hero.x += xDelta;
        }
    }

    function moveY() {
        if (canMoveY) {
            hero.y += yDelta;
        }
    }

    function move() {
        moveX();
        moveY();
        console.log("Hero x:", hero.x);
        console.log("Hero y:", hero.y);
    }

    function calcArea(x1, dx1, y1, dy1, x2, dx2, y2, dy2) {
        if (x1 > x2) {
            x1 = [x2, x2 = x1][0];
            y1 = [y2, y2 = y1][0];
            dx1 = [dx2, dx2 = dx1][0];
            dy1 = [dy2, dy2 = dy1][0];
        }
        let dX = Math.max(x1 + dx1 - x2, 0);
        if (y1 > y2) {
            let result = dX * Math.max(y2 + dy2 - y1, 0);
            // console.log("Result area:", result);
            return result;
        } else {
            let result = dX * Math.max(y1 + dy1 - y2, 0);
            // console.log("Result area:", result); 
            return result;
        }
    }

    function collision() {
        canMoveX = true;
        canMoveY = true;
        for (var i = 0; i < objects.length; ++i) {
            let obj = objects[i];
            if (obj.type == "stone") {
                let yArea = calcArea(hero.x, hero.width, hero.y + yDelta, hero.height, 
                    obj.x, obj.width, obj.y, obj.height);
                let xArea = calcArea(hero.x + xDelta, hero.width, hero.y, hero.height, 
                    obj.x, obj.width, obj.y, obj.height);
                if (xArea > 0) {
                    canMoveX = false;
                    console.log("X Collision with " + obj.id);
                } else {
                    canMoveX = canMoveX & true;
                }
                if (yArea > 0) {
                    canMoveY = false;
                    console.log("Y collision with " + obj.id);
                } else {
                    canMoveY = canMoveY & true;
                }
            }
        }
    }

    function gravity() {
        if (hero.y > 0) {
            yDelta -= 0.01;
        }
    }

    function ineration() {

    }

    var collisionSystem = setInterval(collision, 5);
    var moveSystem = setInterval(move, 1);
    var renderSystem = setInterval(render, 5);
    var gravitySystem = setInterval(gravity, 5);
    // var inertionSystem = setInterval(intertion, 5);
    
    </script>
</body></html>